{% extends "base.html" %}

{% block nav_links %}
<li class="nav-item">
    <a class="nav-link" href="{{ url_for('blog_home') }}">Blog</a>
</li>
<li class="nav-item">
    <a class="nav-link active" href="{{ url_for('blog_write') }}">Write</a>
</li>
{% endblock %}

{% block title %}{{ site_name }} - Write Post{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 mb-0">
                    <i class="bi bi-pencil-square me-2"></i>Write New Post
                </h1>
                <a href="{{ url_for('blog_home') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Back to Blog
                </a>
            </div>

            <!-- Writing Form -->
            <form method="POST" enctype="multipart/form-data" class="mb-5">
                <div class="row">
                    <!-- Main Editor Area -->
                    <div class="col-lg-8">
                        <!-- Title -->
                        <div class="mb-4">
                            <label for="title" class="form-label fw-bold">Post Title *</label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="title" 
                                   name="title" 
                                   placeholder="Enter your post title..." 
                                   required>
                            <div class="form-text">Make it catchy and descriptive</div>
                        </div>

                        <!-- Excerpt -->
                        <div class="mb-4">
                            <label for="excerpt" class="form-label fw-bold">Excerpt</label>
                            <textarea class="form-control" 
                                      id="excerpt" 
                                      name="excerpt" 
                                      rows="3" 
                                      placeholder="Brief description of your post..."></textarea>
                            <div class="form-text">This will be shown in post previews</div>
                        </div>

                        <!-- Content Editor -->
                        <div class="mb-4">
                            <label for="content" class="form-label fw-bold">Content *</label>
                            <div class="border rounded">
                                <!-- Toolbar -->
                                <div class="border-bottom p-2 bg-light">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('bold')">
                                            <i class="bi bi-type-bold"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('italic')">
                                            <i class="bi bi-type-italic"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="formatText('underline')">
                                            <i class="bi bi-type-underline"></i>
                                        </button>
                                    </div>
                                    <div class="btn-group btn-group-sm ms-2" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertText('# ')">H1</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertText('## ')">H2</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertText('### ')">H3</button>
                                    </div>
                                    <div class="btn-group btn-group-sm ms-2" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertText('- ')">
                                            <i class="bi bi-list-ul"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertText('1. ')">
                                            <i class="bi bi-list-ol"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertCode()">
                                            <i class="bi bi-code-square"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="insertText('> ')">
                                            <i class="bi bi-quote"></i>
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Editor -->
                                <textarea class="form-control border-0 rounded-0" 
                                          id="content" 
                                          name="content" 
                                          rows="20" 
                                          placeholder="Start writing your amazing post..." 
                                          required></textarea>
                            </div>
                            <div class="form-text">You can use Markdown formatting</div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="col-lg-4">
                        <!-- Publish Options -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0"><i class="bi bi-gear me-2"></i>Publish Options</h5>
                            </div>
                            <div class="card-body">
                                <!-- Status -->
                                <div class="mb-3">
                                    <label for="status" class="form-label">Status</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="draft">Draft</option>
                                        <option value="published">Published</option>
                                        <option value="scheduled">Scheduled</option>
                                    </select>
                                </div>

                                <!-- Publish Date -->
                                <div class="mb-3">
                                    <label for="publish_date" class="form-label">Publish Date</label>
                                    <input type="datetime-local" class="form-control" id="publish_date" name="publish_date">
                                </div>

                                <!-- Visibility -->
                                <div class="mb-3">
                                    <label for="visibility" class="form-label">Visibility</label>
                                    <select class="form-select" id="visibility" name="visibility">
                                        <option value="public">Public</option>
                                        <option value="private">Private</option>
                                        <option value="password">Password Protected</option>
                                    </select>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-grid gap-2">
                                    <button type="submit" name="action" value="save" class="btn btn-outline-primary">
                                        <i class="bi bi-save me-2"></i>Save Draft
                                    </button>
                                    <button type="submit" name="action" value="preview" class="btn btn-outline-secondary">
                                        <i class="bi bi-eye me-2"></i>Preview
                                    </button>
                                    <button type="submit" name="action" value="publish" class="btn btn-primary">
                                        <i class="bi bi-send me-2"></i>Publish Post
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Category & Tags -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0"><i class="bi bi-tags me-2"></i>Categories & Tags</h5>
                            </div>
                            <div class="card-body">
                                <!-- Category -->
                                <div class="mb-3">
                                    <label for="category" class="form-label">Category</label>
                                    <select class="form-select" id="category" name="category">
                                        <option value="">Select Category</option>
                                        <option value="Programming">Programming</option>
                                        <option value="Web Development">Web Development</option>
                                        <option value="Database">Database</option>
                                        <option value="Tutorials">Tutorials</option>
                                        <option value="Reviews">Reviews</option>
                                    </select>
                                </div>

                                <!-- Tags -->
                                <div class="mb-3">
                                    <label for="tags" class="form-label">Tags</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="tags" 
                                           name="tags" 
                                           placeholder="python, tutorial, beginner">
                                    <div class="form-text">Separate tags with commas</div>
                                </div>

                                <!-- Tag Suggestions -->
                                <div class="mb-3">
                                    <label class="form-label">Popular Tags</label>
                                    <div class="d-flex flex-wrap gap-1">
                                        <button type="button" class="btn btn-outline-secondary btn-sm tag-suggestion" data-tag="python">python</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm tag-suggestion" data-tag="javascript">javascript</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm tag-suggestion" data-tag="tutorial">tutorial</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm tag-suggestion" data-tag="beginner">beginner</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm tag-suggestion" data-tag="web-dev">web-dev</button>
                                        <button type="button" class="btn btn-outline-secondary btn-sm tag-suggestion" data-tag="api">api</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Featured Image -->
                        <div class="card border-0 shadow-sm mb-4">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0"><i class="bi bi-image me-2"></i>Featured Image</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <input type="file" 
                                           class="form-control" 
                                           id="featured_image" 
                                           name="featured_image" 
                                           accept="image/*">
                                </div>
                                <div class="mb-3">
                                    <input type="text" 
                                           class="form-control" 
                                           id="alt_text" 
                                           name="alt_text" 
                                           placeholder="Image alt text">
                                </div>
                                <div id="image-preview" class="text-center d-none">
                                    <img id="preview-img" class="img-fluid rounded" style="max-height: 200px;">
                                </div>
                            </div>
                        </div>

                        <!-- SEO -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-header bg-transparent">
                                <h5 class="mb-0"><i class="bi bi-search me-2"></i>SEO</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="meta_description" class="form-label">Meta Description</label>
                                    <textarea class="form-control" 
                                              id="meta_description" 
                                              name="meta_description" 
                                              rows="3" 
                                              maxlength="160" 
                                              placeholder="Brief description for search engines..."></textarea>
                                    <div class="form-text">Max 160 characters</div>
                                </div>
                                <div class="mb-3">
                                    <label for="slug" class="form-label">URL Slug</label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="slug" 
                                           name="slug" 
                                           placeholder="url-friendly-title">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.tag-suggestion {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
}

.tag-suggestion.active {
    background-color: var(--bs-primary);
    border-color: var(--bs-primary);
    color: white;
}

#image-preview img {
    border: 2px dashed #dee2e6;
    padding: 0.5rem;
}
</style>

<script>
// Editor functions
function formatText(command) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    let formattedText = '';
    switch(command) {
        case 'bold':
            formattedText = `**${selectedText}**`;
            break;
        case 'italic':
            formattedText = `*${selectedText}*`;
            break;
        case 'underline':
            formattedText = `<u>${selectedText}</u>`;
            break;
    }
    
    textarea.setRangeText(formattedText, start, end);
    textarea.focus();
}

function insertText(text) {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    
    textarea.setRangeText(text, start, start);
    textarea.focus();
    textarea.setSelectionRange(start + text.length, start + text.length);
}

function insertCode() {
    const textarea = document.getElementById('content');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const selectedText = textarea.value.substring(start, end);
    
    const codeBlock = selectedText.includes('\n') 
        ? `\`\`\`\n${selectedText}\n\`\`\`` 
        : `\`${selectedText}\``;
    
    textarea.setRangeText(codeBlock, start, end);
    textarea.focus();
}

// Tag suggestions
document.querySelectorAll('.tag-suggestion').forEach(button => {
    button.addEventListener('click', function() {
        const tag = this.dataset.tag;
        const tagsInput = document.getElementById('tags');
        const currentTags = tagsInput.value.split(',').map(t => t.trim()).filter(t => t);
        
        if (!currentTags.includes(tag)) {
            currentTags.push(tag);
            tagsInput.value = currentTags.join(', ');
            this.classList.add('active');
        } else {
            const index = currentTags.indexOf(tag);
            currentTags.splice(index, 1);
            tagsInput.value = currentTags.join(', ');
            this.classList.remove('active');
        }
    });
});

// Image preview
document.getElementById('featured_image').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('image-preview');
            const img = document.getElementById('preview-img');
            img.src = e.target.result;
            preview.classList.remove('d-none');
        };
        reader.readAsDataURL(file);
    }
});

// Auto-generate slug from title
document.getElementById('title').addEventListener('input', function() {
    const slug = this.value
        .toLowerCase()
        .replace(/[^a-z0-9\s-]/g, '')
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        .trim('-');
    
    document.getElementById('slug').value = slug;
});

// Character counter for meta description
document.getElementById('meta_description').addEventListener('input', function() {
    const maxLength = 160;
    const currentLength = this.value.length;
    const helpText = this.nextElementSibling;
    
    helpText.textContent = `${currentLength}/${maxLength} characters`;
    
    if (currentLength > maxLength) {
        helpText.classList.add('text-danger');
    } else {
        helpText.classList.remove('text-danger');
    }
});
</script>
{% endblock %}